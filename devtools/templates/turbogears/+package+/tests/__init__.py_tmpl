# -*- coding: utf-8 -*-
"""Unit and functional test suite for {{project}}."""

import os
import sys

from tg import config
from paste.deploy import loadapp
from routes import url_for
from webtest import TestApp
from nose.tools import eq_

from {{package}} import model

__all__ = ['url_for', 'TestController']


def setUp():
    engine = config['pylons.app_globals'].sa_engine 
    model.init_model(engine)
    model.metadata.create_all(engine)


def tearDown():
    engine = config['pylons.app_globals'].sa_engine
    model.metadata.drop_all(engine)


class ModelTest(object):
    """Base unit test case for the models."""
    
    klass = None
    attrs = {}

    def setup(self):
        try:
            new_attrs = {}
            new_attrs.update(self.attrs)
            new_attrs.update(self.do_get_dependencies())
            self.obj = self.klass(**new_attrs)
            model.DBSession.add(self.obj)
            model.DBSession.flush()
            return self.obj
        except:
            model.DBSession.rollback()
            raise

    def tearDown(self):
        model.DBSession.rollback()

    def do_get_dependencies(self):
        return {}

    def test_create_obj(self):
        pass

    def test_query_obj(self):
        obj = model.DBSession.query(self.klass).one()
        for key, value in self.attrs.iteritems():
            eq_(getattr(obj, key), value)


class TestController(object):
    """Base functional test case for the controllers."""

    def __init__(self, *args, **kwargs):
        conf_dir = config.here
        wsgiapp = loadapp('config:test.ini', relative_to=conf_dir)
        self.app = TestApp(wsgiapp)
